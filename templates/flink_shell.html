<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flink Shell</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/dahua.jpg') }}" alt="Logo" class="logo-img">
            <div class="logo-text">æ™¨æ—­çš„å·¥å…·åŒ…</div>
        </div>
        <div class="nav-links">
            <ul>
                <li class="active">
                    <a href="/">
                        <span class="icon">ğŸ’»</span>
                        <span>Flink Shell</span>
                    </a>
                </li>
                <li>
                    <a href="/code-generator">
                        <span class="icon">ğŸ“¦</span>
                        <span>åˆ†å‘ä»£ç ç”Ÿæˆå™¨</span>
                    </a>
                </li>
                <li>
                    <a href="/flinksql-generator">
                        <span class="icon">âš¡</span>
                        <span>FlinkSQLç”Ÿæˆå™¨</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="flink-shell">
                <div class="shell-header">
                    <div class="connection-info">
                        <select id="env" name="env">
                            <option value="test">æµ‹è¯•ç¯å¢ƒ</option>
                            <option value="prod">ç”Ÿäº§ç¯å¢ƒ</option>
                        </select>
                        <button id="connect-btn">è¿æ¥</button>
                        <span id="connection-status">æœªè¿æ¥</span>
                    </div>
                </div>
                <div class="shell-body">
                    <div class="sql-editor">
                        <textarea id="sql-input" name="sql-input"></textarea>
                    </div>
                    <div class="shell-controls">
                        <button id="execute-btn">æ‰§è¡Œ</button>
                        <button id="format-btn">æ ¼å¼åŒ–</button>
                        <button id="clear-btn">æ¸…ç©º</button>
                    </div>
                    <div class="result-container">
                        <div class="result-tabs">
                            <button class="tab-btn active" data-tab="result">ç»“æœ</button>
                            <button class="tab-btn" data-tab="log">æ—¥å¿—</button>
                        </div>
                        <div class="result-content">
                            <div class="tab-pane active" id="result-pane">
                                <div class="result-table">
                                    <table>
                                        <thead id="result-header"></thead>
                                        <tbody id="result-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane" id="log-pane">
                                <div class="log-content" id="log-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–CodeMirrorç¼–è¾‘å™¨
        const editor = CodeMirror.fromTextArea(document.getElementById('sql-input'), {
            mode: 'text/x-sql',
            theme: 'monokai',
            lineNumbers: true,
            indentWithTabs: true,
            smartIndent: true,
            lineWrapping: true,
            matchBrackets: true,
            autofocus: true,
            extraKeys: {
                "Ctrl-Enter": executeSQL,
                "Ctrl-Space": "autocomplete"
            }
        });

        // è¿æ¥çŠ¶æ€
        let isConnected = false;

        // è¿æ¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('connect-btn').addEventListener('click', function() {
            const env = document.getElementById('env').value;
            const status = document.getElementById('connection-status');
            
            if (!isConnected) {
                // å‘é€è¿æ¥è¯·æ±‚
                fetch('/flink-connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ env: env })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isConnected = true;
                        status.textContent = 'å·²è¿æ¥';
                        status.style.color = 'green';
                        this.textContent = 'æ–­å¼€';
                    } else {
                        alert('è¿æ¥å¤±è´¥ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    alert('è¿æ¥é”™è¯¯ï¼š' + error);
                });
            } else {
                // å‘é€æ–­å¼€è¿æ¥è¯·æ±‚
                fetch('/flink-disconnect', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isConnected = false;
                        status.textContent = 'æœªè¿æ¥';
                        status.style.color = 'red';
                        this.textContent = 'è¿æ¥';
                    }
                });
            }
        });

        // æ‰§è¡ŒSQL
        function executeSQL() {
            if (!isConnected) {
                alert('è¯·å…ˆè¿æ¥åˆ°Flinkç¯å¢ƒ');
                return;
            }

            const sql = editor.getValue();
            if (!sql.trim()) {
                alert('è¯·è¾“å…¥SQLè¯­å¥');
                return;
            }

            // æ˜¾ç¤ºæ‰§è¡Œä¸­çš„çŠ¶æ€
            const logContent = document.getElementById('log-content');
            logContent.innerHTML += `[${new Date().toLocaleTimeString()}] æ‰§è¡ŒSQL: ${sql}\n`;

            // å‘é€SQLæ‰§è¡Œè¯·æ±‚
            fetch('/flink-execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ sql: sql })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ˜¾ç¤ºç»“æœ
                    displayResult(data.result);
                    logContent.innerHTML += `[${new Date().toLocaleTimeString()}] æ‰§è¡ŒæˆåŠŸ\n`;
                } else {
                    logContent.innerHTML += `[${new Date().toLocaleTimeString()}] æ‰§è¡Œå¤±è´¥: ${data.message}\n`;
                }
            })
            .catch(error => {
                logContent.innerHTML += `[${new Date().toLocaleTimeString()}] æ‰§è¡Œé”™è¯¯: ${error}\n`;
            });
        }

        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
        function displayResult(result) {
            const header = document.getElementById('result-header');
            const body = document.getElementById('result-body');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            header.innerHTML = '';
            body.innerHTML = '';
            
            if (result.length === 0) {
                return;
            }

            // åˆ›å»ºè¡¨å¤´
            const tr = document.createElement('tr');
            Object.keys(result[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                tr.appendChild(th);
            });
            header.appendChild(tr);

            // åˆ›å»ºæ•°æ®è¡Œ
            result.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        }

        // æ ¼å¼åŒ–SQL
        document.getElementById('format-btn').addEventListener('click', function() {
            const sql = editor.getValue();
            // è¿™é‡Œå¯ä»¥æ·»åŠ SQLæ ¼å¼åŒ–é€»è¾‘
            editor.setValue(sql);
        });

        // æ¸…ç©ºSQL
        document.getElementById('clear-btn').addEventListener('click', function() {
            editor.setValue('');
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(`${tab}-pane`).classList.add('active');
            });
        });
    </script>
</body>
</html> 